name: Pipeline CI/CD

on:
  push:
    branches:
      - master
      - dev
  pull_request:
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '9.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_NOLOGO: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  SONAR_HOST_URL: 'https://sonarcloud.io'

jobs:
  # ========================================
  # Job 1: Build e AnÃ¡lise de CÃ³digo
  # ========================================
  build-and-analyze:
    name: ğŸ”¨ Build & Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      pull-requests: read

    outputs:
      cache-key: ${{ steps.cache-key.outputs.key }}

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  

      - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ”§ Cache .NET tools
        uses: actions/cache@v4
        with:
          path: ~/.dotnet/tools
          key: ${{ runner.os }}-dotnet-tools-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-tools-

      - name: ğŸ“¥ Restore dependencies
        run: dotnet restore

      - name: ğŸ› ï¸ Build solution
        run: dotnet build --no-restore --configuration Release

      - name: ğŸ”§ Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner --ignore-failed-sources

      - name: ğŸ•µï¸ Begin SonarCloud analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet-sonarscanner begin \
            /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
            /o:"${{ secrets.SONAR_ORGANIZATION }}" \
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="${{ env.SONAR_HOST_URL }}" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" \
            /d:sonar.coverage.exclusions="**/*Tests.cs,**/*Test.cs,**/obj/**,**/bin/**,**/CommomTestUtilities/**" \
            /d:sonar.exclusions="**/Migrations/**,**/obj/**,**/bin/**" \
            /d:sonar.verbose=true

      - name: ğŸ”¨ Build for analysis
        run: dotnet build --no-restore --configuration Release

      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: |
            **/bin/Release/**
            !**/obj/**
          retention-days: 1

      - name: ğŸ’¾ Generate cache key
        id: cache-key
        run: echo "key=${{ runner.os }}-build-${{ github.sha }}" >> $GITHUB_OUTPUT

  # ========================================
  # Job 2: Testes UnitÃ¡rios (Paralelo)
  # ========================================
  unit-tests:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: build-and-analyze

    permissions:
      contents: read

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore dependencies
        run: dotnet restore

      - name: ğŸ§ª Run Validators Tests
        run: |
          echo "ğŸ§ª Running Validators Unit Tests..."
          dotnet test tests/Validators/Validators.Test/Validators.Test.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults/Validators \
            --settings .runsettings \
            --logger "trx;LogFileName=validators-results.trx" \
            --verbosity normal

      - name: ğŸ§ª Run Handlers Tests
        run: |
          echo "ğŸ§ª Running Handlers Unit Tests..."
          dotnet test tests/Handlers/Handlers.Test/Handlers.Test.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults/Handlers \
            --settings .runsettings \
            --logger "trx;LogFileName=handlers-results.trx" \
            --verbosity normal

      - name: ğŸ“Š Upload unit test coverage
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-coverage
          path: |
            ./TestResults/**/coverage.opencover.xml
            ./TestResults/**/*.trx
          retention-days: 7

      - name: âœ… Unit tests summary
        if: always()
        run: |
          echo "âœ… Unit Tests Completed"
          echo "ğŸ“ Coverage files uploaded as artifacts"

  # ========================================
  # Job 3: Testes de IntegraÃ§Ã£o (Paralelo)
  # ========================================
  integration-tests:
    name: ğŸ³ Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: build-and-analyze

    permissions:
      contents: read

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Verify Docker availability
        run: |
          docker --version
          docker compose version
          docker ps
          docker info
          echo "âœ… Docker is ready for Testcontainers"

      - name: ğŸ³ Pull DynamoDB image (cache optimization)
        run: |
          echo "ğŸ“¦ Pre-pulling DynamoDB image to avoid timeout during test..."
          docker pull amazon/dynamodb-local:latest
          echo "âœ… DynamoDB image cached"

      - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ“¥ Restore dependencies
        run: dotnet restore

      - name: ğŸ³ Run Integration Tests
        env:
          DOTNET_ENVIRONMENT: Development
          # Testcontainers - OtimizaÃ§Ãµes para CI/CD
          TESTCONTAINERS_RYUK_DISABLED: false
          TESTCONTAINERS_HUB_IMAGE_NAME_PREFIX: ""
          TESTCONTAINERS_DOCKER_SOCKET_OVERRIDE: /var/run/docker.sock
          DOCKER_HOST: unix:///var/run/docker.sock
          # Logging e diagnÃ³sticos
          TESTCONTAINERS_HOST_OVERRIDE: localhost
          # CI detection
          CI: true
        run: |
          echo "ğŸ³ Running Integration Tests with Testcontainers..."
          echo "ğŸ“Š Test configuration:"
          echo "  - Docker socket: $DOCKER_HOST"
          echo "  - Ryuk enabled: true (cleanup automÃ¡tico)"
          echo "  - Collection Fixture: Compartilhamento de container"
          echo ""

          dotnet test tests/Integration/Integration.Test/Integration.Test.csproj \
            --configuration Release \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults/Integration \
            --settings .runsettings \
            --logger "trx;LogFileName=integration-results.trx" \
            --logger "console;verbosity=detailed" \
            --verbosity normal

          echo ""
          echo "âœ… Integration tests completed"

      - name: ğŸ” Diagnose on failure
        if: failure()
        run: |
          echo "âŒ Integration tests failed. Collecting diagnostics..."
          echo ""
          echo "ğŸ“‹ Docker containers:"
          docker ps -a
          echo ""
          echo "ğŸ“‹ Docker logs (if any Testcontainers running):"
          docker ps -a --filter "label=org.testcontainers=true" --format "{{.ID}}" | xargs -I {} docker logs {} || true
          echo ""
          echo "ğŸ“‹ Test results directory:"
          ls -la ./TestResults/ || echo "No test results found"
          echo ""
          echo "ğŸ’¡ Check the logs above for error details"

      - name: ğŸ“Š Upload integration test coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-coverage
          path: |
            ./TestResults/**/coverage.opencover.xml
            ./TestResults/**/*.trx
          retention-days: 7

      - name: âœ… Integration tests summary
        if: always()
        run: |
          echo "âœ… Integration Tests Completed"
          echo "ğŸ“ Coverage files uploaded as artifacts"

  # ========================================
  # Job 4: ConsolidaÃ§Ã£o e SonarCloud
  # ========================================
  sonar-analysis:
    name: ğŸ“Š SonarCloud Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [build-and-analyze, unit-tests, integration-tests]
    if: always() && (needs.unit-tests.result == 'success' || needs.integration-tests.result == 'success')

    permissions:
      contents: read
      pull-requests: read

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: ğŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: ğŸ”§ Cache .NET tools
        uses: actions/cache@v4
        with:
          path: ~/.dotnet/tools
          key: ${{ runner.os }}-dotnet-tools-${{ hashFiles('**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-dotnet-tools-

      - name: ğŸ“¥ Download unit test coverage
        uses: actions/download-artifact@v4
        with:
          name: unit-test-coverage
          path: ./coverage/unit
        continue-on-error: true

      - name: ğŸ“¥ Download integration test coverage
        uses: actions/download-artifact@v4
        with:
          name: integration-test-coverage
          path: ./coverage/integration
        continue-on-error: true

      - name: ğŸ“¥ Restore dependencies
        run: dotnet restore

      - name: ğŸ”§ Install SonarScanner
        run: dotnet tool install --global dotnet-sonarscanner --ignore-failed-sources

      - name: ğŸ•µï¸ Begin SonarCloud analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet-sonarscanner begin \
            /k:"${{ secrets.SONAR_PROJECT_KEY }}" \
            /o:"${{ secrets.SONAR_ORGANIZATION }}" \
            /d:sonar.token="${{ secrets.SONAR_TOKEN }}" \
            /d:sonar.host.url="${{ env.SONAR_HOST_URL }}" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml" \
            /d:sonar.coverage.exclusions="**/*Tests.cs,**/*Test.cs,**/obj/**,**/bin/**,**/CommomTestUtilities/**" \
            /d:sonar.exclusions="**/Migrations/**,**/obj/**,**/bin/**" \
            /d:sonar.verbose=true

      - name: ğŸ”¨ Build for SonarCloud
        run: dotnet build --no-restore --configuration Release

      - name: ğŸ” Verify coverage files
        run: |
          echo "ğŸ” Searching for coverage files..."
          find . -name "coverage.opencover.xml" -type f -exec echo "ğŸ“„ Found: {}" \; -exec wc -c {} \;

          COVERAGE_COUNT=$(find . -name "coverage.opencover.xml" -type f | wc -l)
          echo "ğŸ“Š Total coverage files found: $COVERAGE_COUNT"

          if [ "$COVERAGE_COUNT" -eq 0 ]; then
            echo "âš ï¸ Warning: No coverage files found, but continuing with analysis"
          else
            echo "âœ… Coverage files verified"
          fi

      - name: ğŸ End SonarCloud analysis
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: dotnet-sonarscanner end /d:sonar.token="${{ secrets.SONAR_TOKEN }}"

      - name: ğŸ“Š Upload consolidated coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: consolidated-coverage
          path: |
            **/coverage.opencover.xml
            **/*.trx
          retention-days: 30

  # ========================================
  # Job 5: Pipeline Status Summary
  # ========================================
  pipeline-summary:
    name: ğŸ“‹ Pipeline Summary
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [build-and-analyze, unit-tests, integration-tests, sonar-analysis]
    if: always()

    steps:
      - name: ğŸ“Š Pipeline Results
        run: |
          echo "========================================="
          echo "ğŸ“‹ PIPELINE EXECUTION SUMMARY"
          echo "========================================="
          echo ""
          echo "ğŸ”¨ Build & Analysis: ${{ needs.build-and-analyze.result }}"
          echo "ğŸ§ª Unit Tests: ${{ needs.unit-tests.result }}"
          echo "ğŸ³ Integration Tests: ${{ needs.integration-tests.result }}"
          echo "ğŸ“Š SonarCloud Analysis: ${{ needs.sonar-analysis.result }}"
          echo ""
          echo "========================================="

          if [[ "${{ needs.build-and-analyze.result }}" == "success" && \
                "${{ needs.unit-tests.result }}" == "success" && \
                "${{ needs.integration-tests.result }}" == "success" && \
                "${{ needs.sonar-analysis.result }}" == "success" ]]; then
            echo "âœ… ALL CHECKS PASSED!"
            exit 0
          else
            echo "âŒ SOME CHECKS FAILED"
            exit 1
          fi
